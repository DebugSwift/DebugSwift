name: Auto Tag and Version

on:
  push:
    branches: 
      - "main"
  workflow_dispatch:

permissions:
   actions: write
   checks: write
   contents: write
   deployments: write
   issues: write
   packages: write
   pull-requests: write
   repository-projects: write
   security-events: write
   statuses: write

jobs:
  git_version:
    name: Determine current version
    runs-on: macos-15
    outputs:
      semVer: ${{ steps.gitversion.outputs.semVer }}
      majorMinorPatch: ${{ steps.gitversion.outputs.majorMinorPatch }}
      preReleaseTag: ${{ steps.gitversion.outputs.preReleaseTag }}
      preReleaseNumber: ${{ steps.gitversion.outputs.preReleaseNumber }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.1'

    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v0
      with:
        versionSpec: '5.x'

    - name: Determine Version
      id: gitversion
      uses: gittools/actions/gitversion/execute@v0

    - name: Display GitVersion
      run: |
        NEW_TAG="${{ steps.gitversion.outputs.semVer }}"
        echo "Semantic Version: $NEW_TAG"
        echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV

  tag:
    name: Create tag and update podspec
    needs: 
      - git_version
    runs-on: ubuntu-latest

    steps:

    - name: Checkout
      uses: actions/checkout@v4

    - name: Update podspec version
      run: |
        NEW_VERSION="${{ needs.git_version.outputs.majorMinorPatch }}"
        echo "Updating podspec version to: $NEW_VERSION"
        
        # Update the version in DebugSwift.podspec
        sed -i "s/s\.version.*=.*/s.version          = '$NEW_VERSION'/" DebugSwift.podspec
        
        # Verify the change
        grep "s.version" DebugSwift.podspec

    - name: Commit podspec changes
      run: |
        git config user.name "GitHub Actions"
        git config user.email "github-actions@users.noreply.github.com"
        
        NEW_VERSION="${{ needs.git_version.outputs.majorMinorPatch }}"
        
        # Check if there are changes to commit
        if git diff --quiet DebugSwift.podspec; then
          echo "No changes to podspec version"
        else
          git add DebugSwift.podspec
          git commit -m "chore: update podspec version to $NEW_VERSION [skip ci]"
          git push origin main
        fi

    - name: Push Git Tag
      run: |
        git config user.name "GitHub Actions"
        git config user.email "github-actions@users.noreply.github.com"
        
        TAG_NAME="${{ needs.git_version.outputs.semVer }}"
        
        git tag $TAG_NAME
        git push origin $TAG_NAME

    - name: Upload podspec artifact
      uses: actions/upload-artifact@v4
      with:
        name: artifact
        path: DebugSwift.podspec

  publish_pod:
    name: Publish pod
    needs: 
      - git_version
      - tag
    runs-on: macos-latest
    steps:
    
    - name: Checkout
      uses: actions/checkout@v4

    - name: Delete old Podspec
      run: |
        if [ -e DebugSwift.podspec ]; then
          rm DebugSwift.podspec
        fi

    - name: Download Artifact
      uses: actions/download-artifact@v4
      with:
        name: artifact

    - run: "pod trunk push DebugSwift.podspec --allow-warnings"
      env:
        COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
    # - run: "pod trunk me clean-sessions --all"
